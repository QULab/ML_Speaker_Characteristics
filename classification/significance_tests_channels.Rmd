---
title: "Mc Nemar's test of statistical differences between voice degradations"
author: "Laura Fernández Gallardo"
date: "April 2018"
output: 
  github_document:
  toc: true
toc_depth: 3
---
  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(root.dir = './')
knitr::opts_chunk$set(fig.width=10, fig.height=5, dpi=150)
```


```{r echo=FALSE}

# clear
rm(list=ls())

```

```{r message=FALSE, warning=FALSE}

# Libraries needed:

library(knitr) # for kable


``` 

## Objectives

To assess the effects of speech degradations on the perfromance of Random Forest classification and Support Vector Machine classification of WAAT.

Classification was performed in [this notebook](https://github.com/laufergall/ML_Speaker_Characteristics/blob/master/classification/04_classification_degraded_speech.ipynb), from where true class 'yt_spk' classification predictions 'yt_spk_pred' were genderated for each classifier.


Load predictions for each classifier.

NA predictions generated when transmission simulations were unsuccessfull (around 7%).

```{r echo=FALSE} 

# setting paths and loading data
setwd("D:/Users/fernandez.laura/Documents/Work/Projects_Github/ML_Speaker_Characteristics/classification")

# read true classes

classes <- read.csv('../data/generated_data/speakerIDs_cls_WAAT_all.csv') 


# read predictions: read csv files which contain 'cls_test_distortionsdegradations'

res <- data.frame()
file.names <- dir('./performance_channels', pattern ="cls_test_distortionsdegradations") 
for(i in 1:length(file.names)){
  dataread <- read.csv(paste0('./performance_channels/',file.names[i]), header=TRUE, sep=",") 
  # get classifier name
  pos <- gregexpr('_', file.names[i])
  dataread$cls <- substr(file.names[i], pos[[1]][3]+1, pos[[1]][4]-1)
  res <- rbind(res,dataread)
  
}

```

Speakers:

```{r}

n_spk <- nrow(classes)
summary(classes)

```

Channel distortions:

```{r}

levels(res$distortion)

```

Channel degradations:

```{r}

levels(res$degradation)

```

Classifiers:

```{r}

unique(res$cls)

```
 
 
## Mc Nemar's tests 

Run McNemar's Chi-squared test (with continuity correction).
The null hypothesis is that there is no difference in the classification.

For each classifier: 
* Perform Mc Nemar's test with each pair of degradations
* Considering constant packet loss rate = 0 and jitter = 0


Generating combinations of conditions to compare:
For each codec, choose the bitrate offering the highest performance. In case of ties, choose the lowest bitrate.


```{r}

combs <- data.frame()

# for each classifier
for (cl in unique(res$cls)){
  
  # subset for classifier and for distortion condition
  res_cls <- res[res$cls == cl,]
  res_cls <- res_cls[res_cls$distortion == 'pl00ji00',]
  
  # generate combinations
  chosen <- c()
  for (co in unique(res_cls$codec)){
    res_cls_co <- res_cls[res_cls$codec == co,]
    posmax <- which.max(res_cls_co$average.per.class.accuracy)
    chosen <- append(chosen, toString(res_cls_co$degradation[posmax]))
  }
  
  combs <- rbind(combs, data.frame(t(combn(chosen, 2)), pval=0, cls=cl) )
  
  # for each pair of degradations, perform McNemar
  for (i in 1:nrow(combs)){
    pair <- combs[i,]
    
    # predictions of each degradation
    preds1 <- as.matrix(res_cls[res_cls$degradation==toString(pair[1,1]),c(5:(5+n_spk-1))])
    preds2 <- as.matrix(res_cls[res_cls$degradation==toString(pair[1,2]),c(5:(5+n_spk-1))])
    
    preds1 <- as.factor(preds1)
    preds2 <- as.factor(preds2)
    
    levels(preds1) <- c(0,1)
    levels(preds2) <- c(0,1)
    
    # create contingency matrix
    contingm <- table(preds1, preds2)
    
    # mcnemar.test and store p.value
    mcn <- mcnemar.test(contingm)
    combs$pval[i] <- mcn$p.value # NA if identical classif (e.g. dummy)
    
    
  }
  
  
}
  

```


Looking only at significant differences at 0.01 level found in RF and SVC classification.

```{r}

# subset for classifiers 
combs_cls <- combs[combs$cls %in% c('RandomForestClassifier','SVCrbf'),]
 
# subset for significant differences 
combs_cls_sig <- combs_cls[combs_cls$pval<0.01,]

```

 
TODO: why NAs?

TODO: Conclusions
